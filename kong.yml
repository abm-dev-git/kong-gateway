_format_version: "3.0"
_transform: true

# Kong Gateway Declarative Configuration
# ABM.dev API Gateway - 27 Routes
#
# This file defines services, routes, plugins, and consumers.
# Source: /data/code/turquoise-koala/config/routes.oas.json
#
# Related Issues:
# - Issue #4: Create kong.yml with all 27 routes
# - Epic #1: Kong Gateway Infrastructure

# ===========================================
# Services (Upstream APIs)
# ===========================================
services:
  # Main ABM.dev Backend API (for authenticated routes)
  - name: abmdev-backend
    url: http://localhost:5003
    connect_timeout: 60000
    write_timeout: 60000
    read_timeout: 120000
    retries: 2
    tags:
      - backend
      - abmdev
      - authenticated

  # Public Backend API (no auth required)
  - name: abmdev-public
    url: http://localhost:5003
    connect_timeout: 60000
    write_timeout: 60000
    read_timeout: 120000
    retries: 2
    tags:
      - backend
      - abmdev
      - public

# ===========================================
# Routes - Public (No Authentication)
# ===========================================
routes:
  # Root welcome endpoint
  - name: root
    service: abmdev-public
    paths:
      - /
    methods:
      - GET
    strip_path: false
    tags:
      - public

  # Health check endpoint
  - name: health-check
    service: abmdev-public
    paths:
      - /health
    methods:
      - GET
    strip_path: false
    tags:
      - public
      - health

  # Clerk webhook (no auth, signature verified by backend)
  - name: webhooks-clerk
    service: abmdev-public
    paths:
      - /webhooks/clerk
    methods:
      - POST
    strip_path: false
    tags:
      - public
      - webhook

# ===========================================
# Routes - Enrichment (20 req/min rate limit)
# ===========================================

  # POST /v1/enrichment/entities -> /api/v1/enrichment/entities
  - name: enrichment-entities
    service: abmdev-backend
    paths:
      - ~/v1/enrichment/entities$
    methods:
      - POST
    strip_path: false
    tags:
      - enrichment
      - authenticated
      - rate-limit-enrichment
    plugins:
      - name: request-transformer
        config:
          replace:
            uri: /api/v1/enrichment/entities

  # GET/POST /v1/enrichment/jobs -> /api/v1/enrichment/jobs
  - name: enrichment-jobs
    service: abmdev-backend
    paths:
      - ~/v1/enrichment/jobs$
    methods:
      - GET
      - POST
    strip_path: false
    tags:
      - enrichment
      - authenticated
      - rate-limit-enrichment
    plugins:
      - name: request-transformer
        config:
          replace:
            uri: /api/v1/enrichment/jobs

  # GET/DELETE /v1/enrichment/jobs/{jobId} -> /api/v1/enrichment/jobs/{jobId}
  - name: enrichment-job-by-id
    service: abmdev-backend
    paths:
      - ~/v1/enrichment/jobs/(?<jobId>[^/]+)$
    methods:
      - GET
      - DELETE
    strip_path: false
    tags:
      - enrichment
      - authenticated
      - rate-limit-enrichment
    plugins:
      - name: request-transformer
        config:
          replace:
            uri: /api/v1/enrichment/jobs/$(uri_captures.jobId)

  # GET /v1/enrichment/jobs/{jobId}/stream -> /api/v1/enrichment/jobs/{jobId}/stream
  - name: enrichment-job-stream
    service: abmdev-backend
    paths:
      - ~/v1/enrichment/jobs/(?<jobId>[^/]+)/stream$
    methods:
      - GET
    strip_path: false
    tags:
      - enrichment
      - authenticated
      - streaming
    plugins:
      - name: request-transformer
        config:
          replace:
            uri: /api/v1/enrichment/jobs/$(uri_captures.jobId)/stream

  # POST /v1/enrichment/preflight -> /api/v1/enrichment/preflight
  - name: enrichment-preflight
    service: abmdev-backend
    paths:
      - ~/v1/enrichment/preflight$
    methods:
      - POST
    strip_path: false
    tags:
      - enrichment
      - authenticated
      - rate-limit-enrichment
    plugins:
      - name: request-transformer
        config:
          replace:
            uri: /api/v1/enrichment/preflight

# ===========================================
# Routes - Configuration (100 req/min rate limit)
# ===========================================

  # GET/POST /v1/enrichment/configurations -> /api/v1/enrichment/configurations
  - name: enrichment-configurations
    service: abmdev-backend
    paths:
      - ~/v1/enrichment/configurations$
    methods:
      - GET
      - POST
    strip_path: false
    tags:
      - configuration
      - authenticated
      - rate-limit-standard
    plugins:
      - name: request-transformer
        config:
          replace:
            uri: /api/v1/enrichment/configurations

  # GET/PUT/DELETE /v1/enrichment/configurations/{configId}
  - name: enrichment-configuration-by-id
    service: abmdev-backend
    paths:
      - ~/v1/enrichment/configurations/(?<configId>[^/]+)$
    methods:
      - GET
      - PUT
      - DELETE
    strip_path: false
    tags:
      - configuration
      - authenticated
      - rate-limit-standard
    plugins:
      - name: request-transformer
        config:
          replace:
            uri: /api/v1/enrichment/configurations/$(uri_captures.configId)

  # GET/POST /v1/enrichment/field-mappings -> /api/v1/enrichment/field-mappings
  - name: enrichment-field-mappings
    service: abmdev-backend
    paths:
      - ~/v1/enrichment/field-mappings$
    methods:
      - GET
      - POST
    strip_path: false
    tags:
      - configuration
      - authenticated
      - rate-limit-standard
    plugins:
      - name: request-transformer
        config:
          replace:
            uri: /api/v1/enrichment/field-mappings

  # GET/PUT/DELETE /v1/enrichment/field-mappings/{mappingId}
  - name: enrichment-field-mapping-by-id
    service: abmdev-backend
    paths:
      - ~/v1/enrichment/field-mappings/(?<mappingId>[^/]+)$
    methods:
      - GET
      - PUT
      - DELETE
    strip_path: false
    tags:
      - configuration
      - authenticated
      - rate-limit-standard
    plugins:
      - name: request-transformer
        config:
          replace:
            uri: /api/v1/enrichment/field-mappings/$(uri_captures.mappingId)

# ===========================================
# Routes - LinkedIn Connection (100 req/min)
# ===========================================

  # GET /v1/linkedin-connection/status
  - name: linkedin-connection-status
    service: abmdev-backend
    paths:
      - ~/v1/linkedin-connection/status$
    methods:
      - GET
    strip_path: false
    tags:
      - linkedin
      - authenticated
      - rate-limit-standard
    plugins:
      - name: request-transformer
        config:
          replace:
            uri: /api/v1/linkedin-connection/status

  # POST /v1/linkedin-connection/initialize
  - name: linkedin-connection-initialize
    service: abmdev-backend
    paths:
      - ~/v1/linkedin-connection/initialize$
    methods:
      - POST
    strip_path: false
    tags:
      - linkedin
      - authenticated
      - rate-limit-standard
    plugins:
      - name: request-transformer
        config:
          replace:
            uri: /api/v1/linkedin-connection/initialize

  # POST /v1/linkedin-connection/verify
  - name: linkedin-connection-verify
    service: abmdev-backend
    paths:
      - ~/v1/linkedin-connection/verify$
    methods:
      - POST
    strip_path: false
    tags:
      - linkedin
      - authenticated
      - rate-limit-standard
    plugins:
      - name: request-transformer
        config:
          replace:
            uri: /api/v1/linkedin-connection/verify

  # DELETE /v1/linkedin-connection
  - name: linkedin-connection-delete
    service: abmdev-backend
    paths:
      - ~/v1/linkedin-connection$
    methods:
      - DELETE
    strip_path: false
    tags:
      - linkedin
      - authenticated
      - rate-limit-standard
    plugins:
      - name: request-transformer
        config:
          replace:
            uri: /api/v1/linkedin-connection

  # GET /v1/linkedin-connection/profile
  - name: linkedin-connection-profile
    service: abmdev-backend
    paths:
      - ~/v1/linkedin-connection/profile$
    methods:
      - GET
    strip_path: false
    tags:
      - linkedin
      - authenticated
      - rate-limit-standard
    plugins:
      - name: request-transformer
        config:
          replace:
            uri: /api/v1/linkedin-connection/profile

# ===========================================
# Routes - HubSpot Integration (100 req/min)
# ===========================================

  # GET/POST /v1/hubspot/contacts
  - name: hubspot-contacts
    service: abmdev-backend
    paths:
      - ~/v1/hubspot/contacts$
    methods:
      - GET
      - POST
    strip_path: false
    tags:
      - hubspot
      - authenticated
      - rate-limit-standard
    plugins:
      - name: request-transformer
        config:
          replace:
            uri: /api/v1/hubspot/contacts

  # GET/PATCH /v1/hubspot/contacts/{contactId}
  - name: hubspot-contact-by-id
    service: abmdev-backend
    paths:
      - ~/v1/hubspot/contacts/(?<contactId>[^/]+)$
    methods:
      - GET
      - PATCH
    strip_path: false
    tags:
      - hubspot
      - authenticated
      - rate-limit-standard
    plugins:
      - name: request-transformer
        config:
          replace:
            uri: /api/v1/hubspot/contacts/$(uri_captures.contactId)

  # GET/POST /v1/hubspot/companies
  - name: hubspot-companies
    service: abmdev-backend
    paths:
      - ~/v1/hubspot/companies$
    methods:
      - GET
      - POST
    strip_path: false
    tags:
      - hubspot
      - authenticated
      - rate-limit-standard
    plugins:
      - name: request-transformer
        config:
          replace:
            uri: /api/v1/hubspot/companies

  # GET /v1/hubspot/properties/contacts
  - name: hubspot-properties-contacts
    service: abmdev-backend
    paths:
      - ~/v1/hubspot/properties/contacts$
    methods:
      - GET
    strip_path: false
    tags:
      - hubspot
      - authenticated
      - rate-limit-standard
    plugins:
      - name: request-transformer
        config:
          replace:
            uri: /api/v1/hubspot/properties/contacts

  # POST /v1/hubspot/sync
  - name: hubspot-sync
    service: abmdev-backend
    paths:
      - ~/v1/hubspot/sync$
    methods:
      - POST
    strip_path: false
    tags:
      - hubspot
      - authenticated
      - rate-limit-standard
    plugins:
      - name: request-transformer
        config:
          replace:
            uri: /api/v1/hubspot/sync

  # POST /v1/hubspot/dedup/check
  - name: hubspot-dedup-check
    service: abmdev-backend
    paths:
      - ~/v1/hubspot/dedup/check$
    methods:
      - POST
    strip_path: false
    tags:
      - hubspot
      - authenticated
      - rate-limit-standard
    plugins:
      - name: request-transformer
        config:
          replace:
            uri: /api/v1/hubspot/dedup/check

# ===========================================
# Routes - API Keys (100 req/min)
# ===========================================

  # GET/POST /v1/api-keys -> /api/v1/ApiKeys
  - name: api-keys
    service: abmdev-backend
    paths:
      - ~/v1/api-keys$
    methods:
      - GET
      - POST
    strip_path: false
    tags:
      - api-keys
      - authenticated
      - rate-limit-standard
    plugins:
      - name: request-transformer
        config:
          replace:
            uri: /api/v1/ApiKeys

  # DELETE /v1/api-keys/{keyId} -> /api/v1/ApiKeys/{keyId}
  - name: api-key-by-id
    service: abmdev-backend
    paths:
      - ~/v1/api-keys/(?<keyId>[^/]+)$
    methods:
      - DELETE
    strip_path: false
    tags:
      - api-keys
      - authenticated
      - rate-limit-standard
    plugins:
      - name: request-transformer
        config:
          replace:
            uri: /api/v1/ApiKeys/$(uri_captures.keyId)

# ===========================================
# Routes - Organizations (100 req/min)
# ===========================================

  # GET /v1/organizations/current
  - name: organizations-current
    service: abmdev-backend
    paths:
      - ~/v1/organizations/current$
    methods:
      - GET
    strip_path: false
    tags:
      - organization
      - authenticated
      - rate-limit-standard
    plugins:
      - name: request-transformer
        config:
          replace:
            uri: /api/v1/organizations/current

  # GET /v1/organizations/current/usage
  - name: organizations-usage
    service: abmdev-backend
    paths:
      - ~/v1/organizations/current/usage$
    methods:
      - GET
    strip_path: false
    tags:
      - organization
      - authenticated
      - rate-limit-standard
    plugins:
      - name: request-transformer
        config:
          replace:
            uri: /api/v1/organizations/current/usage

# ===========================================
# Routes - Status (No rate limit)
# ===========================================

  # GET /v1/status
  - name: status
    service: abmdev-backend
    paths:
      - ~/v1/status$
    methods:
      - GET
    strip_path: false
    tags:
      - status
      - authenticated
    plugins:
      - name: request-transformer
        config:
          replace:
            uri: /api/v1/status

  # GET /v1/status/linkedin
  - name: status-linkedin
    service: abmdev-backend
    paths:
      - ~/v1/status/linkedin$
    methods:
      - GET
    strip_path: false
    tags:
      - status
      - authenticated
    plugins:
      - name: request-transformer
        config:
          replace:
            uri: /api/v1/status/linkedin

  # GET /v1/status/hunter
  - name: status-hunter
    service: abmdev-backend
    paths:
      - ~/v1/status/hunter$
    methods:
      - GET
    strip_path: false
    tags:
      - status
      - authenticated
    plugins:
      - name: request-transformer
        config:
          replace:
            uri: /api/v1/status/hunter

  # GET /v1/status/hubspot
  - name: status-hubspot
    service: abmdev-backend
    paths:
      - ~/v1/status/hubspot$
    methods:
      - GET
    strip_path: false
    tags:
      - status
      - authenticated
    plugins:
      - name: request-transformer
        config:
          replace:
            uri: /api/v1/status/hubspot

# ===========================================
# Global Plugins
# ===========================================
plugins:
  # Correlation ID for request tracing (all routes)
  # Generates unique ID for each request for distributed tracing
  - name: correlation-id
    tags:
      - tracing
      - correlation
    config:
      header_name: x-correlation-id
      generator: uuid#counter
      echo_downstream: true

  # Post-function plugin to extract org_id from JWT claims
  # Sets x-org-id header for rate limiting and backend authorization
  # Note: This runs after JWT plugin validates the token
  - name: post-function
    tags:
      - transformer
      - org-id
    config:
      access:
        - |
          -- Extract org_id from JWT claims and set as header
          local jwt_claims = kong.ctx.shared.authenticated_jwt_claims
          if jwt_claims and jwt_claims.org_id then
            kong.service.request.set_header("x-org-id", jwt_claims.org_id)
            kong.log.debug("Set x-org-id header from JWT: ", jwt_claims.org_id)
          else
            -- Try to get org_id from API key consumer custom_id
            local consumer = kong.client.get_consumer()
            if consumer and consumer.custom_id then
              -- Custom ID format: org_<id> for API key consumers
              local org_id = consumer.custom_id
              if org_id:sub(1, 4) == "org_" then
                kong.service.request.set_header("x-org-id", org_id)
                kong.log.debug("Set x-org-id header from consumer: ", org_id)
              end
            end
          end

  # JWT Authentication Plugin (for authenticated service only)
  # Uses anonymous consumer fallback for Either/Or auth pattern
  - name: jwt
    service: abmdev-backend
    tags:
      - authentication
      - jwt
    config:
      # Header locations to check for JWT
      header_names:
        - Authorization
      # Don't check URI params or cookies
      uri_param_names: []
      cookie_names: []
      # Claims to verify
      claims_to_verify:
        - exp
      # Key claim for identifying the issuer
      key_claim_name: iss
      # Not base64 encoded
      secret_is_base64: false
      # Run on preflight requests
      run_on_preflight: true
      # Anonymous consumer fallback (enables Either/Or auth)
      # If JWT validation fails, fall through to key-auth plugin
      anonymous: anonymous

  # Key Authentication Plugin (for authenticated service only)
  # Uses anonymous consumer fallback for Either/Or auth pattern
  - name: key-auth
    service: abmdev-backend
    tags:
      - authentication
      - api-key
    config:
      # Header and query param names to check for API key
      key_names:
        - x-api-key
        - apikey
      # Check in both header and query
      key_in_header: true
      key_in_query: true
      key_in_body: false
      # Don't hide the credential from upstream
      hide_credentials: false
      # Anonymous consumer fallback (enables Either/Or auth)
      # If API key validation fails, fall through to anonymous consumer
      anonymous: anonymous

  # Request Termination Plugin (for anonymous consumer on authenticated service)
  # Rejects requests that fall through to anonymous consumer
  # This ensures unauthenticated requests get a proper 401 response
  - name: request-termination
    service: abmdev-backend
    consumer: anonymous
    tags:
      - authentication
      - termination
    config:
      status_code: 401
      message: "Authentication required. Provide JWT Bearer token or x-api-key header."

# ===========================================
# Rate Limiting Plugins
# ===========================================
# Rate limits are applied per org_id (from x-org-id header)
# Two tiers:
#   - Enrichment routes: 20 requests/minute (expensive operations)
#   - Standard routes: 100 requests/minute
#
# Rate limiting is applied via Admin API after startup using tags:
#   - Routes with tag 'rate-limit-enrichment' get 20/min
#   - Routes with tag 'rate-limit-standard' get 100/min
#
# Run: ./scripts/setup-rate-limiting.sh
#
# Note: Global rate-limit plugin below is a fallback for untagged routes

  # Global fallback rate limit (applies to all routes)
  # More specific rate limits are added via Admin API to tagged routes
  - name: rate-limiting
    tags:
      - rate-limiting
      - global
    config:
      # Default global limit
      minute: 1000
      # Use Redis for distributed rate limiting
      policy: redis
      redis_host: 127.0.0.1
      redis_port: 6380
      redis_timeout: 2000
      # Limit by x-org-id header (set by request-transformer in Issue #8)
      limit_by: header
      header_name: x-org-id
      # Return rate limit headers
      hide_client_headers: false
      # Count all response statuses
      fault_tolerant: true

# ===========================================
# Consumers
# ===========================================
consumers:
  # Anonymous consumer for fallback auth pattern
  # When both JWT and API-key auth fail, this consumer is used
  # Request Termination plugin (Issue #6) will reject these requests
  - username: anonymous
    custom_id: anonymous-fallback
    tags:
      - anonymous
      - fallback

  # Clerk JWT Consumer
  # JWTs from Clerk will be validated against this consumer
  - username: clerk-jwt
    custom_id: clerk-issuer
    tags:
      - clerk
      - jwt

# ===========================================
# JWT Secrets (Clerk JWKS Configuration)
# ===========================================
# Note: Kong OSS doesn't support JWKS URL directly in declarative config.
# The JWT public key must be added via Admin API after startup:
#
# curl -X POST http://localhost:8081/consumers/clerk-jwt/jwt \
#   -d "algorithm=RS256" \
#   -d "key=https://your-clerk-domain.clerk.accounts.dev" \
#   -d "rsa_public_key=<PEM encoded public key>"
#
# Alternatively, fetch from Clerk JWKS endpoint:
# curl https://your-clerk-domain.clerk.accounts.dev/.well-known/jwks.json
#
# For automated setup, use scripts/setup-clerk-jwt.sh
